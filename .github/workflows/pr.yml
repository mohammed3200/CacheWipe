name: Pull Request Checks

on:
    pull_request:
        types: [opened, synchronize, reopened]

jobs:
    validate:
        name: Validate PR
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.21"

            - name: Check formatting
              run: |
                  if [ -n "$(gofmt -s -l .)" ]; then
                    echo "Go code is not formatted:"
                    gofmt -s -d .
                    exit 1
                  fi

            - name: Run go vet
              run: go vet ./...

            - name: Run tests with coverage
              run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

            - name: Check test coverage
              run: |
                  coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
                  echo "Total coverage: $coverage%"
                  if (( $(echo "$coverage < 50" | bc -l) )); then
                    echo "Coverage is below 50%"
                    exit 1
                  fi

            - name: Build
              run: go build -v ./...
